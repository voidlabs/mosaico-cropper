{"version":3,"file":"jqueryui-mosaico-cropper.min.js","sources":["../src/js/url-adapters.js","../src/js/jqueryui-mosaico-cropper.js"],"sourcesContent":["// src/js/url-adapters.js\n\n// Definizione delle dipendenze\nconst _urlParserPatterns = {\n    encodedUrlOriginal: '[^ &\\\\?]+',\n    width: '[0-9]+',\n    height: '[0-9]+',\n    resizeWidth: '[0-9]+',\n    resizeHeight: '[0-9]+',\n    offsetX: '[0-9]+',\n    offsetY: '[0-9]+',\n    cropWidth: '[0-9]+',\n    cropHeight: '[0-9]+',\n    cropX: '[0-9]+',\n    cropY: '[0-9]+',\n    cropX2: '[0-9]+',\n    cropY2: '[0-9]+',\n};\n\nconst methods = [ 'original', 'resize', 'cover', 'cropresize', 'resizecrop' ];\n\nfunction _urlParser(pattern, customPatterns, url) {\n    var matchNames = [];\n    var regex = new RegExp('^'+pattern.replace(/\\\\.|(\\((?!\\?[!:=]))|\\{([^:\\}]+)(?::([^\\}]+))?\\}/g, function(match, braket, groupName, subPattern, offset, input_string) {\n        // console.log(\"X\", match, braket, groupName, subPattern, offset, input_string);\n        if (braket) {\n            // existing regex match\n            matchNames.push('');\n            return match;\n        } else if (groupName) {\n            // named group\n            matchNames.push(groupName);\n            if (!subPattern) {\n                if (_urlParserPatterns[groupName]) subPattern = _urlParserPatterns[groupName];\n                else if (customPatterns !== undefined && customPatterns[groupName]) subPattern = customPatterns[groupName];\n            }\n            if (subPattern) {\n                // deal with sub patterns matching groups\n                subPattern.replace(/\\\\.|(\\((?!\\?[!:=]))/g, function(innerMatch, innerBraket) {\n                    if (innerBraket) matchNames.push('');\n                    return match;\n                });\n                return '('+subPattern+')';\n            // encodedUrlOriginal may not have \"http://\" prefix\n            }\n            // else if (_urlParserPatterns[groupName]) return '('+_urlParserPatterns[groupName]+')';\n            // else if (customPatterns !== undefined && customPatterns[groupName]) return '('+customPatterns[groupName]+')';\n            else {\n                console.error(pattern, url, customPatterns);\n                throw \"Uknown token \"+groupName+\", please use {\"+groupName+\":regex} or use a known pattern\";\n            }\n        } else {\n            // escaped char\n            return match;\n        }\n    })+'$');\n\n    var res = url.match(regex);\n\n    var matches = null;\n    if (res !== null) {\n        if (res.length !== matchNames.length + 1) {\n            // TODO improve error reporting\n            console.log(\"ERROR parsing image url according to pattern!\", pattern, matchNames, res);\n        }\n        matches = {};\n        for (var i = 0; i < matchNames.length; i++) {\n            if (matchNames[i] !== '' && res[i+1] !== undefined) {\n                matches[matchNames[i]] = res[i+1];\n            }\n        }\n    }\n    // console.log(\"p\", matches, pattern, url, matchNames, regex);\n    return matches;\n}\n\nfunction _stringTemplate(string, obj) {\n    // if a token is in the {token:something} format, then \":something\" is completely ignored\n    return string.replace(/\\{([^[\\}:]+)(?::[^\\}]+)?\\}/g, function(match, contents, offset, input_string) {\n        if (obj.hasOwnProperty(contents)) {\n            return obj[contents] !== undefined ? obj[contents] : '';\n        } else {\n            return match;\n        }\n    });\n}\n\n// Definizione delle funzioni principali (rendile 'export function')\nexport function urlAdapterFromSrc(urlAdapter, urlData, src) {\n  var fromSrc = urlAdapter.fromSrc;\n  if (typeof fromSrc == 'object') {\n      var toSrc = urlAdapter.toSrc;\n      var patterns = [];\n      for (var p in toSrc) if (toSrc.hasOwnProperty(p)) {\n          // escaping regexp special chars, excluding {} that we use for tokens.\n          patterns.push(toSrc[p].replace(/[.*+?^$()|[\\]\\\\]/g, '\\\\$&'));\n      }\n      var composedPattern = \"(\"+patterns.join(\"|\")+\")\";\n      var origFromSrc = fromSrc;\n      fromSrc = _urlParser.bind(undefined, composedPattern, origFromSrc);\n  }\n  if (typeof fromSrc == 'string') {\n      fromSrc = _urlParser.bind(undefined, fromSrc, undefined);\n  }\n  var urlAdapterResult = fromSrc(src);\n\n  if (!urlAdapterResult) {\n    if (urlAdapter.defaultPrefix !== undefined) {\n        urlData.urlOriginal = src;\n        urlData.urlPrefix = urlAdapter.defaultPrefix;\n        urlData.urlPostfix = src;\n    } else {\n        // TODO handle bad parameters, log it and fails the initialization!\n        console.error(\"FAILED PARSING\", src);\n    }\n  } else if (urlAdapterResult.encodedUrlOriginal) {\n    urlAdapterResult.urlOriginal = decodeURIComponent(urlAdapterResult.encodedUrlOriginal);\n  }\n\n  return urlAdapterResult;\n}\n\nexport function urlAdapterToSrc(urlAdapter, urlData, res) {\n\n    // TODO TEMP\n    // console.log(\"computedSize\", res.method, res._scale, res);\n\n    res.urlPrefix = urlData.urlPrefix;\n    res.urlPostfix = urlData.urlPostfix;\n    res.urlOriginal = urlData.urlOriginal;\n    res.encodedUrlOriginal = encodeURIComponent(urlData.urlOriginal);\n\n    var toSrc = urlAdapter.toSrc;\n    if (typeof toSrc == 'object') {\n        for (var i = methods.indexOf(res.method); i < methods.length; i++) {\n            if (typeof toSrc[methods[i]] !== 'undefined') {\n                toSrc = toSrc[methods[i]];\n                // console.log(\"Using method \"+methods[i]+\" for original method \"+res.method+\":\", toSrc);\n                break;\n            }\n        }\n    }\n    if (typeof toSrc == 'string') {\n        toSrc = _stringTemplate.bind(undefined, toSrc);\n        // console.log(\"Mapping method string to function\", toSrc);\n    }\n    return toSrc(res);\n}","// Importa le nuove funzioni di gestione URL\nimport { urlAdapterFromSrc, urlAdapterToSrc } from './url-adapters.js';\n\n(function($) {\n\n  $.widget(\"mosaico.mosaicoCropper\", {\n\n    options: {\n        autoClose: true,\n        shiftWheel: false,\n    },\n\n    _init: function() {\n        if (this.options.instance !== undefined) {\n            this.options.instance.dispose(true);\n        }\n        this.options.instance = mosaicoCropper(this.element.get(0), this.options, this);\n    },\n\n    scale: function(value) {\n        if (value === undefined) {\n            return this.options.instance.getScale();\n        } else {\n            this.options.instance.updateScale(value);\n        }\n    },\n\n    cropHeight: function(value) {\n        if (value === undefined) {\n            return this.options.instance.getCropHeight();\n        } else {\n            this.options.instance.updateCropHeight(value);\n        }\n    },\n\n    _destroy: function() {\n        this.options.instance.dispose(true);\n    },\n\n  });\n\nfunction mosaicoCropper(imgEl, options, widget) {\n\n    var htmlTemplate = '<div class=\"mo-cropper cropper-hidden\" tabindex=\"-1\">'+\n      '<div class=\"cropper-frame\">'+\n        '<div class=\"clipping-container\">'+\n          '<div class=\"toolbar\">'+\n            '<div class=\"tool tool-zoom\"><i class=\"fa fa-compress\" aria-hidden=\"true\"></i></div>'+\n            '<div class=\"copper-zoom-slider\"></div>'+\n            '<div class=\"tool tool-crop\"><i class=\"fa fa-check\" aria-hidden=\"true\"></i></div>'+\n          '</div>'+\n          '<img draggable=\"false\" class=\"clipped clipped-image original-src\">'+\n        '</div>'+\n        // '<div class=\"clip-handle ui-resizable-s\"></div>'+\n      '</div>'+\n      '<div class=\"outer-image-container\">'+\n        '<img class=\"outer-image original-src\">'+\n      '</div>'+\n    '</div>';\n\n    /** GETTERS **/\n\n    function getScaledImageSize(scale) {\n        return {\n            width: Math.round(originalImageSize.width * (scale || cropModel.scale)),\n            height: Math.round(originalImageSize.height * (scale || cropModel.scale))\n        };\n    }\n\n    function getCropHeight() {\n        return cropModel.crop.Height;\n    }\n\n    function getScale() {\n        return cropModel.scale;\n    }\n\n    function getMaxScale() {\n        if (typeof options.maxScale !== 'undefined') return options.maxScale;\n        else return 2;\n    }\n\n\n    /** UTILITIES **/\n\n    var movingTimeout = false;\n    var isMoving = false;\n\n    function addMovingClass(className) {\n        if (movingTimeout) clearTimeout(movingTimeout);\n        if (!isMoving) {\n            rootEl.addClass(\"cropper-moving\");\n            rootEl.addClass(\"cropper-moving-\"+className);\n            isMoving = className;\n        }\n    }\n    function removeMovingClass() {\n        if (movingTimeout) clearTimeout(movingTimeout);\n        if (isMoving) {\n            rootEl.removeClass(\"cropper-moving\");\n            rootEl.removeClass(\"cropper-moving-\"+isMoving);\n            isMoving = false;\n        }\n    }\n\n    function toggleMovingClass(className) {\n        if (isMoving) removeMovingClass();\n        else addMovingClass(className);\n    }\n\n\n\n    function checkRange(value, min, max) {\n        if (value < min) return min;\n        if (value > max) return max;\n        return value;\n    }\n\n\n    /** DOM UPDATE METHODS **/\n\n    function updateScaledImageSize(newScale) {\n        if (cropModel.scale !== newScale) {\n            cropModel.scale = newScale;\n            var scaledSize = getScaledImageSize();\n            var newSizes = {\n                width: scaledSize.width+\"px\",\n                height: scaledSize.height+\"px\"\n            };\n            clippedEl.css(newSizes);\n            imageCropContainerEl.css(newSizes);\n            return true;\n        } else return false;\n    }\n\n    function updateCropperFrameSize(newCropHeight, newCropWidth) {\n        cropModel.crop.height = parseInt(newCropHeight);\n        if (newCropWidth !== undefined) {\n            cropModel.crop.width = parseInt(newCropWidth);\n            rootEl.css({ width: cropModel.crop.width+\"px\" });\n        }\n        cropperFrameEl.css({ height: cropModel.crop.height+\"px\", width: cropModel.crop.width+\"px\" });\n\n        // Compute new minScale\n        // TODO options.width should not be used here\n        var widthRatio = options.width / originalImageSize.width,\n            heightRatio = cropModel.crop.height / originalImageSize.height,\n            minScale = Math.max(widthRatio, heightRatio);\n        if (minScale !== cropModel.minScale) {\n            cropModel.minScale = minScale;\n            sliderEl.slider({ min: _fromScaleToSliderValue(minScale) });\n        }\n    }\n\n    function updateCropContainerPanZoom(newLeft, newTop, newScale, updateCropContainer, updateSlider) {\n        var changed = false;\n\n        if (newScale !== undefined) {\n            changed = updateScaledImageSize(newScale);\n        }\n\n        var scaledSize = getScaledImageSize();\n        // Constraints\n        if (newLeft !== undefined) {\n            newLeft = checkRange(newLeft, cropModel.crop.width - scaledSize.width, 0);\n            if (cropModel.container.left !== newLeft) {\n                cropModel.container.left = newLeft;\n                changed = true;\n            }\n        }\n\n        if (newTop !== undefined) {\n            newTop = checkRange(newTop, cropModel.crop.height - scaledSize.height, 0);\n            if (cropModel.container.top !== newTop) {\n                cropModel.container.top = newTop;\n                changed = true;\n            }\n        }\n\n        if (changed) {\n            var newSizes = {\n                left: cropModel.container.left+\"px\",\n                top: cropModel.container.top+\"px\"\n            };\n            if (updateCropContainer === undefined || updateCropContainer) imageCropContainerEl.css(newSizes);\n            // clippedEl.css(\"transform\", \"translateX(\"+cropModel.container.left+\"px) translateY(\"+cropModel.container.top+\"px)\");\n            clippedEl.css(newSizes);\n\n            if (newScale && updateSlider !== false) sliderEl.slider(\"value\", _fromScaleToSliderValue(newScale) );\n        }\n\n        return changed;\n    }\n\n    function updatePanZoomToFitCropContainer() {\n        // TODO this code is similar to the initializeSizes, maybe we should merge them.\n        var newScale, newLeft, newTop;\n        newScale = cropModel.minScale;\n        var resizedSize = getScaledImageSize(newScale);\n        newLeft = Math.round((cropModel.crop.width - resizedSize.width) / 2);\n        newTop = Math.round((cropModel.crop.height - resizedSize.height) / 2);\n        return updateCropContainerPanZoom(newLeft, newTop, newScale);\n    }\n\n    function updateScale(newScale, xp, yp, updateSlider) {\n        var scaledSize = getScaledImageSize();\n        if (xp == undefined) xp = (cropModel.crop.width / 2 - cropModel.container.left) / scaledSize.width;\n        if (yp == undefined) yp = (cropModel.crop.height / 2 - cropModel.container.top) / scaledSize.height;\n\n        newScale = checkRange(newScale, cropModel.minScale, getMaxScale());\n        if (newScale !== cropModel.scale) {\n            var newScaledSize = getScaledImageSize(newScale),\n                xd = Math.round((newScaledSize.width - scaledSize.width) * xp),\n                yd = Math.round((newScaledSize.height - scaledSize.height) * yp),\n                newLeft = cropModel.container.left - xd,\n                newTop = cropModel.container.top - yd;\n\n            updateCropContainerPanZoom(newLeft, newTop, newScale, undefined, updateSlider);\n            return true;\n        } else return false;\n    }\n\n    function updateCropHeightInternal(method, newHeight, origHeight, originalOuterTop, maxHeight) {\n        // Containment. An alternative to \"containment\" would be auto-zooming when reaching the maxHeight (but de-zooming would be counter-intuitive)\n        if (!options.autoZoom && newHeight > maxHeight) newHeight = maxHeight;\n\n        newHeight = Math.round(newHeight);\n\n        updateCropperFrameSize(newHeight);\n\n        // If we are in a \"basic\" manipulation we want to be sure we stay in \"cover\" mode instead of cropresize.\n        if (method == 'original' || method == 'cover' || method == 'resize') {\n            updatePanZoomToFitCropContainer();\n        // This deal with autozoom.\n        } else if (newHeight > maxHeight) {\n            var newScale = newHeight / originalImageSize.height;\n            updateScale(newScale);\n        } else {\n            // Crop using vertical centering\n            var newOuterTop = Math.round((newHeight - origHeight) / 2) + originalOuterTop;\n            if (newOuterTop > 0) newOuterTop = 0;\n            updateCropContainerPanZoom(undefined, newOuterTop);\n        }\n    }\n\n    function updateCropHeight(newHeight) {\n        var origHeight = cropModel.crop.height;\n        updateCropHeightInternal(getCurrentComputedMethod(), newHeight, origHeight, cropModel.container.top, getScaledImageSize().height);\n        return origHeight !== cropModel.crop.height;\n    }\n\n    function updatePanZoomCropToFitWidthAndAspect() {\n        var newScale = options.width / originalImageSize.width;\n        var newHeight = Math.round(originalImageSize.height * newScale);\n        // TODO maybe we could merge the updateScale in the updateCropHeight call.\n        var changed = updateCropHeight(newHeight);\n        changed = updateScale(newScale) || changed;\n        return changed;\n    }\n\n    function updateSmartAutoResize() {\n        var done = updatePanZoomToFitCropContainer();\n        if (!done) {\n            // TODO: This step should be available only when resizer is available.\n            done = updatePanZoomCropToFitWidthAndAspect();\n            if (!done) {\n                updateScale(1);\n            }\n        }\n        changed(\"autosize\");\n    }\n\n    /** INITIALIZATION METHODS */\n\n    // TODO make this method parametrizable so to take a direction (down vs right)\n    function initializeResizer() { // g\n        var originalOuterTop;\n        var maxHeight;\n        var originalMethod;\n\n        cropperFrameEl.append('<div class=\"clip-handle ui-resizable-s\"></div>');\n        cropperFrameEl.resizable({\n            minHeight: 40,\n            handles: { s: '.clip-handle' },\n            /* containment: outerEl, */ /* se voglio fare che il resize sposta sul centro non posso usare il containment */\n            start: function(event, ui) {\n                rootEl.focus();\n                addMovingClass('handle');\n                originalOuterTop = cropModel.container.top;\n                originalMethod = getCurrentComputedMethod();\n                maxHeight = getScaledImageSize().height;\n            },\n            stop: function(event, ui) {\n                removeMovingClass();\n                changed(\"resized\");\n            },\n            resize: function(event, ui) {\n                var topDiff = cropModel.container.top - originalOuterTop;\n                updateCropHeightInternal(originalMethod, ui.size.height, ui.originalSize.height, originalOuterTop, maxHeight);\n                changed(\"resizing\");\n                ui.size.height = cropModel.crop.height;\n                if (typeof widget !== 'undefined') widget._trigger('cropheight', null, { value: cropModel.crop.height });\n            },\n        });\n        cropperFrameEl.find('.clip-handle').on(\"dblclick\", function(event) {\n            updateCropHeight(getScaledImageSize().height);\n            changed(\"resized\");\n            return false;\n        });\n    }\n\n    function initializeDraggable() { // h\n        imageCropContainerEl.draggable({\n            scroll: false, // TODO not sure it is better with false. Need some testing.\n            start: function(event, ui) {\n                rootEl.focus();\n                addMovingClass('drag');\n            },\n            stop: function(event, ui) {\n                changed(\"dragged\");\n                removeMovingClass();\n            },\n            drag: function(event, ui) {\n                updateCropContainerPanZoom(Math.round(ui.position.left), Math.round(ui.position.top), undefined, false);\n                ui.position.left = cropModel.container.left;\n                ui.position.top = cropModel.container.top;\n                changed(\"dragging\");\n            },\n        }).on(\"wheel\", function(event) {\n            if (options.shiftWheel && !event.shiftKey) return true;\n\n            var delta = -event.originalEvent.deltaY;\n            rootEl.focus();\n\n            if (delta !== 0) {\n                addMovingClass('wheel');\n                movingTimeout = setTimeout(removeMovingClass, 500);\n\n                var scaledSize = getScaledImageSize();\n                // console.log(event.originalEvent.layerX, event.originalEvent.offsetX, event.originalEvent.layerX | event.originalEvent.offsetX);\n                var xp = event.originalEvent.offsetX / scaledSize.width;\n                var yp = event.originalEvent.offsetY / scaledSize.height;\n\n                var newScale = delta > 0 ? cropModel.scale*1.1 : (cropModel.scale/1.1);\n                updateScale(newScale, xp, yp);\n                changed(\"wheel\");\n            }\n\n            return false;\n        }).on(\"dblclick\", function(event) {\n            // TODO temporary added the functionality to doubleclick\n            updateSmartAutoResize();\n            return false;\n        }).on(\"click\", function(event) {\n            rootEl.focus();\n            toggleMovingClass('click');\n        });\n    }\n\n    /* Make the slider zoom binding logaritmic so to have more precision on the left side of the slider */\n    function _fromSliderValueToScale(value) {\n        return Math.pow(1.03, value) / 100;\n    }\n\n    function _fromScaleToSliderValue(scale) {\n        return Math.log(scale * 100) / Math.log(1.03);\n    }\n\n    function initializeSlider() {\n        // SLIDER\n        sliderEl.slider({\n            min: Math.floor(_fromScaleToSliderValue(cropModel.minScale)),\n            step: 1,\n            value: Math.round(_fromScaleToSliderValue(cropModel.scale)),\n            max: Math.ceil(_fromScaleToSliderValue(getMaxScale())), // zoom 2 means the output image will be very low quality (4 pixels from 1 original pixel)\n            slide: function(event, ui) {\n                var newScale = _fromSliderValueToScale(ui.value);\n                updateScale(newScale, undefined, undefined, false);\n                changed(\"slide\");\n                ui.value = _fromScaleToSliderValue(cropModel.scale);\n            },\n            start: function() {\n                addMovingClass('slide');               \n            },\n            stop: function() {\n                removeMovingClass('slide');               \n            },\n        });\n    }\n\n    function initializeSizes() {\n        var newCropHeight, newLeft, newTop, newScale, newWidth;\n\n        // resizeWith, resizeHeight, offsetX, offestY, width and height must be manipulated according to \"ppp\"\n        // crop* instead must not be changed.\n        if (typeof options.ppp !== 'undefined') {\n            // console.log(\"ppp\", options.ppp, options.width, Math.round(options.width / options.ppp));\n            // TODO when ppp is used we should not overwrite input options but only work on internal variables\n            // but some code still reads input options.\n            options.width = Math.round(options.width / options.ppp);\n            if (typeof options.height !== 'undefined') options.height = Math.round(options.height / options.ppp);\n            if (typeof options.resizeWidth !== 'undefined') options.resizeWidth = Math.round(options.resizeWidth / options.ppp);\n            if (typeof options.resizeHeight !== 'undefined') options.resizeHeight = Math.round(options.resizeHeight / options.ppp);\n            if (typeof options.offsetX !== 'undefined') options.offsetX = Math.round(options.offsetX / options.ppp);\n            if (typeof options.offsetY !== 'undefined') options.offsetY = Math.round(options.offsetY / options.ppp);\n        }\n\n        if (typeof options.resizeWidth !== 'undefined') {\n            // resizecrop\n            newScale = options.resizeWidth / originalImageSize.width;\n            newCropHeight = options.height;\n            newWidth = options.width;\n            newLeft = -options.offsetX;\n            newTop = -options.offsetY;\n        } else if (typeof options.cropX2 !== 'undefined' || typeof options.cropWidth !== 'undefined') {\n            // cropresize\n            // TODO error reporting for missing mandatory parameters.\n            if (options.cropWidth == undefined) options.cropWidth = options.cropX2 - options.cropX;\n            if (options.cropHeight == undefined) options.cropHeight = options.cropY2 - options.cropY;\n            if (options.cropX == undefined) options.cropX = 0;\n            if (options.cropY == undefined) options.cropY = 0;\n            newScale = options.width / options.cropWidth;\n            newCropHeight = options.height || options.cropHeight * newScale;\n            newWidth = options.width;\n            newLeft = Math.round(-options.cropX * newScale);\n            newTop = Math.round(-options.cropY * newScale);\n        } else if (typeof options.height !== 'undefined') {\n            // cover\n            newScale = Math.max(options.width / originalImageSize.width, options.height / originalImageSize.height);\n            newWidth = Math.min(options.width, Math.round(originalImageSize.width * newScale));\n            newCropHeight = Math.min(options.height, Math.round(originalImageSize.height * newScale));\n            var resizedSize = getScaledImageSize(newScale);\n            newLeft = Math.round((newWidth - resizedSize.width) / 2);\n            newTop = Math.round((newCropHeight - resizedSize.height) / 2);\n        } else if (typeof options.width) {\n            // resize\n            newScale = options.width / originalImageSize.width;\n            newCropHeight = Math.round(originalImageSize.height * newScale);\n            newWidth = options.width;\n            newLeft = 0;\n            newTop = 0;\n        } else {\n            // TODO error reporting unexpected parameters\n        }\n\n        updateCropperFrameSize(newCropHeight, newWidth);\n        updateCropContainerPanZoom(newLeft, newTop, newScale);\n        updateCropperMethod();\n    }\n\n    function initialize() {\n    \tif (containerEl) containerEl.addClass(\"cropper-cropping\");\n\n\n        if (options.autoClose !== false) {\n            rootEl.focusout(function(a) {\n                // On ie11 we have to use the contains method to check for real \"focusout\" events.\n                if ((a.relatedTarget == null || !rootEl.get(0).contains(a.relatedTarget)) && typeof a.delegatedTarget == 'undefined' && !disposing) {\n                    updateAndDispose();\n                }\n            });\n        }\n\n        rootEl.find('.tool-crop').on(\"click\", function() {\n            updateAndDispose();\n            // rootEl.triggerHandler('focusout');\n        });\n\n        rootEl.find('.tool-zoom').on(\"click\", function() {\n            updateSmartAutoResize();\n        });\n\n        rootEl.focus();\n\n        initializeSizes();\n        // TODO parametrize vertical resizer presence (note that also the zoom button is currently allowed to change the cropHeight and should be changed according to the presence of the cropper)\n        initializeResizer();\n        initializeDraggable();\n        initializeSlider();\n\n        // initialized\n        $(imgEl).css(\"display\", \"none\");\n\n        rootEl.css(\"display\", origDisplay == 'inline' ? 'inline-block' : origDisplay);\n        rootEl.removeClass(\"cropper-hidden\");\n\n        rootEl.focus();\n\n        if (typeof widget !== 'undefined') widget._trigger('copperready');\n    }\n\n    var lastMethod;\n\n    function updateCropperMethod() {\n        var ccsMethod = getCurrentComputedMethod();\n        // console.log(\"CURRENT METHOD\", ccs.method);\n        if (lastMethod !== ccsMethod) {\n            rootEl.removeClass(\"cropper-method-\"+lastMethod);\n            lastMethod = ccsMethod;\n            rootEl.addClass(\"cropper-method-\"+lastMethod);\n        }\n    }\n\n    function changed() { // n\n        updateCropperMethod();\n        rootEl.addClass(\"cropper-has-changes\");\n    }\n\n    // NOTA: _stringTemplate Ã¨ stato spostato in url-adapters.js\n\n    function getCurrentComputedMethod() {\n        return getCurrentComputedSizes().method;\n    }\n\n    function getCurrentComputedSizes() {\n        var scaledSize = getScaledImageSize();\n\n        var width = scaledSize.width,\n            height = scaledSize.height,\n            scale = cropModel.scale;\n\n        var l = -cropModel.container.left,\n            r = width - cropModel.crop.width + cropModel.container.left,\n            t = -cropModel.container.top,\n            b = height - cropModel.crop.height + cropModel.container.top;\n\n\n        // TODO should get this from an option, but maybe not the way \n        var ppp = 1;\n        if (typeof options.ppp !== 'undefined') ppp = options.ppp;\n        // TODO we should support non integer ppps too.\n        if (ppp * scale > 1) ppp = Math.ceil(1 / scale);\n\n        var res = {\n            resizeWidth: Math.round(width * ppp),\n            resizeHeight: Math.round(height * ppp),\n            offsetX: Math.round(Math.max(0, -cropModel.container.left) * ppp),\n            offsetY: Math.round(Math.max(0, -cropModel.container.top) * ppp),\n            cropX: Math.max(0, Math.round(l / scale)),\n            cropY: Math.max(0, Math.round(t / scale)),\n            cropWidth: Math.round(cropModel.crop.width / scale),\n            cropHeight: Math.round(cropModel.crop.height / scale),\n            width: Math.round(cropModel.crop.width * ppp),\n            height: Math.round(cropModel.crop.height * ppp),\n            _scale: scale\n        };\n\n        res.cropX2 = res.cropX + res.cropWidth;\n        res.cropY2 = res.cropY + res.cropHeight;\n        // TODO check X2 vs X2b\n        // res.cropX2b = Math.round((l+cropModel.crop.width) / cropModel.scale); // Math.min(originalImageSize.width, );\n        // res.cropY2b = Math.round((t+cropModel.crop.height) / cropModel.scale); // Math.min(originalImageSize.height, );\n        // if (res.cropX2 !== res.cropX2b) console.debug(\"TODO check best X2 pos: \", res.cropX2, res.cropX2b);\n        // if (res.cropY2 !== res.cropY2b) console.debug(\"TODO check best Y2 pos: \", res.cropY2, res.cropY2b);\n        // TODO check out of bound indexes (we have protections on negative numbers, but not on the max width/height/right/bottom)\n\n        var dx = Math.abs(l-r),\n            dy = Math.abs(t-b);\n\n        res.method = options.resizeWidth !== undefined ? 'resizecrop' : 'cropresize';\n        if (dx <= 1 && dy <= 1 && (l === 0 || t === 0)) {\n            if (l === 0 && t === 0) res.method = scale !== 1 ? 'resize' : 'original';\n            else res.method = 'cover';\n        }\n\n        return res;\n    }\n\n    function updateOriginalImageSrc(done, fail) { // n\n        try {\n            var res = getCurrentComputedSizes();\n            var url = urlAdapterToSrc(options.urlAdapter, options, res);\n\n            rootEl.addClass(\"cropper-loading\");\n\n            preloadImage(url, function(img, src) {\n                $(imgEl).attr('src', src);\n                // not needed, as we're going to remove the whole element.\n                rootEl.removeClass(\"cropper-loading\");\n                done();\n            }, function(err) {\n                rootEl.removeClass(\"cropper-loading\");\n                rootEl.addClass(\"cropper-has-changes\");\n                fail();\n            });\n\n            rootEl.removeClass(\"cropper-has-changes\");\n\n            if (options.imgLoadingClass) $(imgEl).removeClass(options.imgLoadingClass);\n        } catch (error) {\n            console.error(\"Failed generating final URL\", error);\n            // if something gone wrong, call fail callback.\n            fail();\n        }\n    }\n\n    function updateAndDispose() {\n        if (!closing) {\n            closing = true;\n            updateOriginalImageSrc(dispose, function() { \n                // TODO what should we do when saving fails?\n                // TODO logging\n                dispose();\n                closing = false;\n            });\n        }\n    }\n\n    function dispose(noCallback) {\n        if (disposing) return;\n        else disposing = true;\n\n        if (containerEl) containerEl.removeClass(\"cropper-cropping\");\n\n        try {\n            cropperFrameEl.find('.clip-handle').remove();\n            cropperFrameEl.resizable(\"destroy\");\n            imageCropContainerEl.draggable(\"destroy\");\n            sliderEl.slider(\"destroy\");\n        } catch (error) {\n            \n        }\n\n        rootEl.remove();\n\n        if (options.imgLoadingClass) $(imgEl).removeClass(options.imgLoadingClass);\n\n        // rootEl.addClass(\"cropper-hidden\");\n        $(imgEl).css(\"display\", origDisplay);\n\n        if (!noCallback && typeof widget !== 'undefined') widget.destroy();\n    }\n\n    function preloadImage(src, done, error) {\n        var img = new Image();\n        img.onload = function() {\n            done(img, src);\n        };\n        img.onerror = function(err) {\n            // TODO error reporting.\n            console.log(\"TODO img preload failed\", err);\n            if (error) error(src);\n        };\n        img.src = src;\n    }\n\n\n    var rootEl = $(htmlTemplate);\n\n    $(imgEl).before(rootEl);\n    if (options.imgLoadingClass) $(imgEl).addClass(options.imgLoadingClass);\n\n    var urlData = urlAdapterFromSrc(options.urlAdapter, options, imgEl.src);\n\n    $.extend(options, urlData);\n    if (!options.width) {\n        // TODO maybe I have to use the original size instead of the options\n        options.width = imgEl.width;\n        options.height = imgEl.height;\n    }\n\n    // TODO we only support 1:1 aspect ratios.\n    var wr = options.width / imgEl.width;\n    var hr = options.height ? options.height / imgEl.height : wr;\n    if (Math.abs(wr / hr - 1) > 0.01) {\n        console.error(\"Unexpected aspect ratio: \", options.width, options.height, imgEl.width, imgEl.height, wr, hr);\n    }\n    // image pixels per image \"html\" size (so to support 2x 3x retina crops)\n    options.ppp = wr;\n\n\n    var thisVar = this,\n        clippedEl = rootEl.find(\".clipped\"),\n        cropperFrameEl = rootEl.find(\".cropper-frame\"),\n        imageCropContainerEl = rootEl.find(\".outer-image-container\"),  // (b.find(\".hidden-image\"),    // u\n        sliderEl = rootEl.find('.copper-zoom-slider'),\n        origDisplay = $(imgEl).css(\"display\"),\n        disposing = false,\n        closing = false,\n        originalImageSize;\n\n\n    var containerEl = false;\n    if (typeof options.containerSelector !== 'undefined') {\n        containerEl = $(options.containerSelector);\n    }\n\n    var cropModel = {\n        container: {},\n        crop: {},\n      //minScale: 0,\n    };\n\n    var fullOriginalImgUrl = options.urlOriginal || (options.urlPrefix || '')+(options.urlPostfix || '');\n\n    // if the fullOriginalImgUrl doesn't have a scheme, prepend http:// (cloudimage likes this)\n    if (!fullOriginalImgUrl.match(/[a-z]+:/)) fullOriginalImgUrl = 'http://'+fullOriginalImgUrl;\n\n    preloadImage(fullOriginalImgUrl, function(img, src) {\n        rootEl.find(\".original-src\").attr('src', src);\n        originalImageSize = {\n            width: img.naturalWidth,\n            height: img.naturalHeight\n        };\n        // initialize.call(thisVar);\n        initialize();\n    }, function(src) {\n        // TODO handle initialization error\n        setTimeout(dispose);\n    });\n\n    return {\n        getScale: getScale,\n        updateScale: updateScale,\n        getCropHeight: getCropHeight,\n        updateCropHeight: updateCropHeight,\n        dispose: dispose,\n    };\n\n}\n\n}(jQuery));\n"],"names":["_urlParserPatterns","encodedUrlOriginal","width","height","resizeWidth","resizeHeight","offsetX","offsetY","cropWidth","cropHeight","cropX","cropY","cropX2","cropY2","methods","_urlParser","pattern","customPatterns","url","matchNames","regex","RegExp","replace","match","braket","groupName","subPattern","offset","input_string","push","innerMatch","innerBraket","console","error","res","matches","length","log","i","_stringTemplate","string","obj","contents","hasOwnProperty","$","jQuery","widget","options","autoClose","shiftWheel","_init","this","instance","dispose","imgEl","getScaledImageSize","scale","Math","round","originalImageSize","cropModel","getCropHeight","crop","Height","getScale","getMaxScale","maxScale","lastMethod","movingTimeout","isMoving","addMovingClass","className","rootEl","addClass","removeMovingClass","removeClass","toggleMovingClass","checkRange","value","min","max","updateScaledImageSize","newScale","scaledSize","newSizes","clippedEl","css","imageCropContainerEl","updateCropperFrameSize","newCropHeight","newCropWidth","parseInt","cropperFrameEl","widthRatio","heightRatio","minScale","sliderEl","slider","_fromScaleToSliderValue","updateCropContainerPanZoom","newLeft","newTop","updateCropContainer","updateSlider","changed","container","left","top","updatePanZoomToFitCropContainer","resizedSize","updateScale","xp","yp","newScaledSize","xd","yd","updateCropHeightInternal","method","newHeight","origHeight","originalOuterTop","maxHeight","autoZoom","newOuterTop","updateCropHeight","getCurrentComputedMethod","updatePanZoomCropToFitWidthAndAspect","updateSmartAutoResize","done","initializeResizer","originalMethod","append","resizable","minHeight","handles","s","start","event","ui","focus","stop","resize","size","originalSize","_trigger","find","on","initializeDraggable","draggable","scroll","drag","position","shiftKey","delta","originalEvent","deltaY","setTimeout","_fromSliderValueToScale","pow","initializeSlider","floor","step","ceil","slide","initializeSizes","newWidth","ppp","updateCropperMethod","initialize","containerEl","focusout","a","relatedTarget","get","contains","delegatedTarget","disposing","updateAndDispose","origDisplay","ccsMethod","getCurrentComputedSizes","l","r","t","b","_scale","dx","abs","dy","updateOriginalImageSrc","fail","urlAdapter","urlData","urlPrefix","urlPostfix","urlOriginal","encodeURIComponent","toSrc","indexOf","bind","urlAdapterToSrc","preloadImage","img","src","attr","err","imgLoadingClass","closing","noCallback","remove","destroy","Image","onload","onerror","before","fromSrc","patterns","p","composedPattern","join","origFromSrc","urlAdapterResult","decodeURIComponent","defaultPrefix","urlAdapterFromSrc","extend","wr","hr","containerSelector","fullOriginalImgUrl","naturalWidth","naturalHeight","mosaicoCropper","element","_destroy"],"mappings":"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"}