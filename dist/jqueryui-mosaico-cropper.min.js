!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";const t={encodedUrlOriginal:"[^ &\\?]+",width:"[0-9]+",height:"[0-9]+",resizeWidth:"[0-9]+",resizeHeight:"[0-9]+",offsetX:"[0-9]+",offsetY:"[0-9]+",cropWidth:"[0-9]+",cropHeight:"[0-9]+",cropX:"[0-9]+",cropY:"[0-9]+",cropX2:"[0-9]+",cropY2:"[0-9]+"},i=["original","resize","cover","cropresize","resizecrop"];function e(i,e,o){var s=[],n=new RegExp("^"+i.replace(/\\.|(\((?!\?[!:=]))|\{([^:\}]+)(?::([^\}]+))?\}/g,function(n,r,a,h,p,c){if(r)return s.push(""),n;if(a){if(s.push(a),h||(t[a]?h=t[a]:void 0!==e&&e[a]&&(h=e[a])),h)return h.replace(/\\.|(\((?!\?[!:=]))/g,function(t,i){return i&&s.push(""),n}),"("+h+")";throw console.error(i,o,e),"Uknown token "+a+", please use {"+a+":regex} or use a known pattern"}return n})+"$"),r=o.match(n),a=null;if(null!==r){r.length!==s.length+1&&console.log("ERROR parsing image url according to pattern!",i,s,r),a={};for(var h=0;h<s.length;h++)""!==s[h]&&void 0!==r[h+1]&&(a[s[h]]=r[h+1])}return a}function o(t,i){return t.replace(/\{([^[\}:]+)(?::[^\}]+)?\}/g,function(t,e,o,s){return i.hasOwnProperty(e)?void 0!==i[e]?i[e]:"":t})}class s{constructor(t={},i){if(!i)throw new Error("CropModel requires originalImageSize parameter");this.state={container:{left:0,top:0},crop:{width:0,height:0},scale:1,minScale:0},this.originalImageSize=i,this.options=t,this.listeners={}}on(t,i){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(i)}emit(t,i){this.listeners[t]&&this.listeners[t].forEach(t=>t(i))}getCropHeight(){return this.state.crop.height}getScale(){return this.state.scale}getMaxScale(){return void 0!==this.options.maxScale?this.options.maxScale:2}getScaledImageSize(t){return{width:Math.round(this.originalImageSize.width*(t||this.state.scale)),height:Math.round(this.originalImageSize.height*(t||this.state.scale))}}checkRange(t,i,e){return t<i?i:t>e?e:t}getCurrentComputedMethod(){return this.getCurrentComputedSizes().method}getCurrentComputedSizes(){var t=this.getScaledImageSize(),i=t.width,e=t.height,o=this.state.scale,s=-this.state.container.left,n=i-this.state.crop.width+this.state.container.left,r=-this.state.container.top,a=e-this.state.crop.height+this.state.container.top,h=1;void 0!==this.options.ppp&&(h=this.options.ppp),h*o>1&&(h=Math.ceil(1/o));var p={resizeWidth:Math.round(i*h),resizeHeight:Math.round(e*h),offsetX:Math.round(Math.max(0,-this.state.container.left)*h),offsetY:Math.round(Math.max(0,-this.state.container.top)*h),cropX:Math.max(0,Math.round(s/o)),cropY:Math.max(0,Math.round(r/o)),cropWidth:Math.round(this.state.crop.width/o),cropHeight:Math.round(this.state.crop.height/o),width:Math.round(this.state.crop.width*h),height:Math.round(this.state.crop.height*h),_scale:o};p.cropX2=p.cropX+p.cropWidth,p.cropY2=p.cropY+p.cropHeight;var c=Math.abs(s-n),d=Math.abs(r-a);return p.method=void 0!==this.options.resizeWidth?"resizecrop":"cropresize",c<=1&&d<=1&&(0===s||0===r)&&(p.method=0===s&&0===r?1!==o?"resize":"original":"cover"),p}updateScale(t,i,e){var o=this.getScaledImageSize();if(null==i&&(i=(this.state.crop.width/2-this.state.container.left)/o.width),null==e&&(e=(this.state.crop.height/2-this.state.container.top)/o.height),(t=this.checkRange(t,this.state.minScale,this.getMaxScale()))!==this.state.scale){var s=this.getScaledImageSize(t),n=Math.round((s.width-o.width)*i),r=Math.round((s.height-o.height)*e),a=this.state.container.left-n,h=this.state.container.top-r;return this.updateCropContainerPanZoom(a,h,t),!0}return!1}updateScaledImageSize(t){if(this.state.scale!==t){this.state.scale=t;var i=this.getScaledImageSize();return this.emit("scaleChanged",{scale:t,scaledSize:i}),!0}return!1}updateCropperFrameSize(t,i){var e=!1;if(void 0!==t&&(this.state.crop.height=parseInt(t),e=!0),void 0!==i&&(this.state.crop.width=parseInt(i),e=!0),e){if(this.originalImageSize&&this.options.width){var o=this.options.width/this.originalImageSize.width,s=this.state.crop.height/this.originalImageSize.height,n=Math.max(o,s);n!==this.state.minScale&&(this.state.minScale=n,this.emit("minScaleChanged",{minScale:n}))}this.emit("cropSizeChanged",{width:this.state.crop.width,height:this.state.crop.height})}}updateCropContainerPanZoom(t,i,e){var o=!1;void 0!==e&&(o=this.updateScaledImageSize(e));var s=this.getScaledImageSize();return void 0!==t&&(t=this.checkRange(t,this.state.crop.width-s.width,0),this.state.container.left!==t&&(this.state.container.left=t,o=!0)),void 0!==i&&(i=this.checkRange(i,this.state.crop.height-s.height,0),this.state.container.top!==i&&(this.state.container.top=i,o=!0)),o&&this.emit("containerPositionChanged",{left:this.state.container.left,top:this.state.container.top}),o}updatePanZoomToFitCropContainer(){var t,i,e;t=this.state.minScale;var o=this.getScaledImageSize(t);return i=Math.round((this.state.crop.width-o.width)/2),e=Math.round((this.state.crop.height-o.height)/2),this.updateCropContainerPanZoom(i,e,t)}updateCropHeightInternal(t,i,e,o,s){if(!this.options.autoZoom&&i>s&&(i=s),i=Math.round(i),this.updateCropperFrameSize(i),"original"==t||"cover"==t||"resize"==t)this.updatePanZoomToFitCropContainer();else if(i>s){var n=i/this.originalImageSize.height;this.updateScale(n)}else{var r=Math.round((i-e)/2)+o;r>0&&(r=0),this.updateCropContainerPanZoom(void 0,r)}}updateCropHeight(t){var i=this.state.crop.height;return this.updateCropHeightInternal(this.getCurrentComputedMethod(),t,i,this.state.container.top,this.getScaledImageSize().height),i!==this.state.crop.height}updatePanZoomCropToFitWidthAndAspect(){if(!this.options.width)return!1;var t=this.options.width/this.originalImageSize.width,i=Math.round(this.originalImageSize.height*t),e=this.updateCropHeight(i);return e=this.updateScale(t)||e}updateSmartAutoResize(){var t=this.updatePanZoomToFitCropContainer();t||(t=this.updatePanZoomCropToFitWidthAndAspect())||this.updateScale(1),this.emit("modelUpdated",{reason:"autosize"})}initializeSizes(){var t,i,e,o,s;if(void 0!==this.options.ppp&&(this.options.width=Math.round(this.options.width/this.options.ppp),void 0!==this.options.height&&(this.options.height=Math.round(this.options.height/this.options.ppp)),void 0!==this.options.resizeWidth&&(this.options.resizeWidth=Math.round(this.options.resizeWidth/this.options.ppp)),void 0!==this.options.resizeHeight&&(this.options.resizeHeight=Math.round(this.options.resizeHeight/this.options.ppp)),void 0!==this.options.offsetX&&(this.options.offsetX=Math.round(this.options.offsetX/this.options.ppp)),void 0!==this.options.offsetY&&(this.options.offsetY=Math.round(this.options.offsetY/this.options.ppp))),void 0!==this.options.resizeWidth)o=this.options.resizeWidth/this.originalImageSize.width,t=this.options.height,s=this.options.width,i=-this.options.offsetX,e=-this.options.offsetY;else if(void 0!==this.options.cropX2||void 0!==this.options.cropWidth)null==this.options.cropWidth&&(this.options.cropWidth=this.options.cropX2-this.options.cropX),null==this.options.cropHeight&&(this.options.cropHeight=this.options.cropY2-this.options.cropY),null==this.options.cropX&&(this.options.cropX=0),null==this.options.cropY&&(this.options.cropY=0),o=this.options.width/this.options.cropWidth,t=this.options.height||this.options.cropHeight*o,s=this.options.width,i=Math.round(-this.options.cropX*o),e=Math.round(-this.options.cropY*o);else if(void 0!==this.options.height){o=Math.max(this.options.width/this.originalImageSize.width,this.options.height/this.originalImageSize.height),s=Math.min(this.options.width,Math.round(this.originalImageSize.width*o)),t=Math.min(this.options.height,Math.round(this.originalImageSize.height*o));var n=this.getScaledImageSize(o);i=Math.round((s-n.width)/2),e=Math.round((t-n.height)/2)}else this.options.width,o=this.options.width/this.originalImageSize.width,t=Math.round(this.originalImageSize.height*o),s=this.options.width,i=0,e=0;this.updateCropperFrameSize(t,s),this.updateCropContainerPanZoom(i,e,o)}}var n;(n=jQuery).widget("mosaico.mosaicoCropper",{options:{autoClose:!0,shiftWheel:!1},_init:function(){void 0!==this.options.instance&&this.options.instance.dispose(!0),this.options.instance=function(t,r,a){var h,p=!1,c=!1;function d(t){p&&clearTimeout(p),c||(b.addClass("cropper-moving"),b.addClass("cropper-moving-"+t),c=t)}function l(){p&&clearTimeout(p),c&&(b.removeClass("cropper-moving"),b.removeClass("cropper-moving-"+c),c=!1)}function g(t){c?l():d(t)}function u(){var t,i,e;R.append('<div class="clip-handle ui-resizable-s"></div>'),R.resizable({minHeight:40,handles:{s:".clip-handle"},start:function(o,s){b.focus(),d("handle"),t=k.state.container.top,e=k.getCurrentComputedMethod(),i=k.getScaledImageSize().height},stop:function(t,i){l(),w()},resize:function(o,s){k.state.container.top,k.updateCropHeightInternal(e,s.size.height,s.originalSize.height,t,i),w(),s.size.height=k.state.crop.height,void 0!==a&&a._trigger("cropheight",null,{value:k.getCropHeight()})}}),R.find(".clip-handle").on("dblclick",function(t){return k.updateCropHeight(k.getScaledImageSize().height),w(),!1})}function f(){T.draggable({scroll:!1,start:function(t,i){b.focus(),d("drag")},stop:function(t,i){w(),l()},drag:function(t,i){k.updateCropContainerPanZoom(Math.round(i.position.left),Math.round(i.position.top)),i.position.left=k.state.container.left,i.position.top=k.state.container.top,w()}}).on("wheel",function(t){if(r.shiftWheel&&!t.shiftKey)return!0;var i=-t.originalEvent.deltaY;if(b.focus(),0!==i){d("wheel"),p=setTimeout(l,500);var e=k.getScaledImageSize(),o=t.originalEvent.offsetX/e.width,s=t.originalEvent.offsetY/e.height,n=i>0?1.1*k.getScale():k.getScale()/1.1;k.updateScale(n,o,s),w()}return!1}).on("dblclick",function(t){return k.updateSmartAutoResize(),!1}).on("click",function(t){b.focus(),g("click")})}function m(t){return Math.pow(1.03,t)/100}function v(t){return Math.log(100*t)/Math.log(1.03)}function S(){Z.slider({min:Math.floor(v(k.state.minScale)),step:1,value:Math.round(v(k.getScale())),max:Math.ceil(v(k.getMaxScale())),slide:function(t,i){var e=m(i.value);k.updateScale(e),w(),i.value=v(k.getScale())},start:function(){d("slide")},stop:function(){l()}})}function C(){E&&E.addClass("cropper-cropping"),!1!==r.autoClose&&b.focusout(function(t){null!=t.relatedTarget&&b.get(0).contains(t.relatedTarget)||void 0!==t.delegatedTarget||U||x()}),b.find(".tool-crop").on("click",function(){x()}),b.find(".tool-zoom").on("click",function(){k.updateSmartAutoResize()}),b.focus(),k.initializeSizes(),z(),u(),f(),S(),n(t).css("display","none"),b.css("display","inline"==A?"inline-block":A),b.removeClass("cropper-hidden"),b.focus(),void 0!==a&&a._trigger("copperready")}function z(){var t=k.getCurrentComputedMethod();h!==t&&(b.removeClass("cropper-method-"+h),h=t,b.addClass("cropper-method-"+h))}function w(){z(),b.addClass("cropper-has-changes")}function M(){return k.getCurrentComputedSizes()}function I(e,s){try{var a=M(),h=function(t,e,s){s.urlPrefix=e.urlPrefix,s.urlPostfix=e.urlPostfix,s.urlOriginal=e.urlOriginal,s.encodedUrlOriginal=encodeURIComponent(e.urlOriginal);var n=t.toSrc;if("object"==typeof n)for(var r=i.indexOf(s.method);r<i.length;r++)if(void 0!==n[i[r]]){n=n[i[r]];break}return"string"==typeof n&&(n=o.bind(void 0,n)),n(s)}(r.urlAdapter,r,a);b.addClass("cropper-loading"),P(h,function(i,o){n(t).attr("src",o),b.removeClass("cropper-loading"),e()},function(t){b.removeClass("cropper-loading"),b.addClass("cropper-has-changes"),s()}),b.removeClass("cropper-has-changes"),r.imgLoadingClass&&n(t).removeClass(r.imgLoadingClass)}catch(p){console.error("Failed generating final URL",p),s()}}function x(){F||(F=!0,I(H,function(){H(),F=!1}))}function H(i){if(!U){U=!0,E&&E.removeClass("cropper-cropping");try{R.find(".clip-handle").remove(),R.resizable("destroy"),T.draggable("destroy"),Z.slider("destroy")}catch(e){}b.remove(),r.imgLoadingClass&&n(t).removeClass(r.imgLoadingClass),n(t).css("display",A),i||void 0===a||a.destroy()}}function P(t,i,e){var o=new Image;o.onload=function(){i(o,t)},o.onerror=function(i){console.log("TODO img preload failed",i),e&&e(t)},o.src=t}var b=n('<div class="mo-cropper cropper-hidden" tabindex="-1"><div class="cropper-frame"><div class="clipping-container"><div class="toolbar"><div class="tool tool-zoom"><i class="fa fa-compress" aria-hidden="true"></i></div><div class="copper-zoom-slider"></div><div class="tool tool-crop"><i class="fa fa-check" aria-hidden="true"></i></div></div><img draggable="false" class="clipped clipped-image original-src"></div></div><div class="outer-image-container"><img class="outer-image original-src"></div></div>');n(t).before(b),r.imgLoadingClass&&n(t).addClass(r.imgLoadingClass);var y=function(t,i,o){var s=t.fromSrc;if("object"==typeof s){var n=t.toSrc,r=[];for(var a in n)n.hasOwnProperty(a)&&r.push(n[a].replace(/[.*+?^$()|[\]\\]/g,"\\$&"));var h="("+r.join("|")+")",p=s;s=e.bind(void 0,h,p)}"string"==typeof s&&(s=e.bind(void 0,s,void 0));var c=s(o);return c?c.encodedUrlOriginal&&(c.urlOriginal=decodeURIComponent(c.encodedUrlOriginal)):void 0!==t.defaultPrefix?(i.urlOriginal=o,i.urlPrefix=t.defaultPrefix,i.urlPostfix=o):console.error("FAILED PARSING",o),c}(r.urlAdapter,r,t.src);n.extend(r,y),r.width||(r.width=t.width,r.height=t.height);var W=r.width/t.width,X=r.height?r.height/t.height:W;Math.abs(W/X-1)>.01&&console.error("Unexpected aspect ratio: ",r.width,r.height,t.width,t.height,W,X),r.ppp=W;var Y,k,O=b.find(".clipped"),R=b.find(".cropper-frame"),T=b.find(".outer-image-container"),Z=b.find(".copper-zoom-slider"),A=n(t).css("display"),U=!1,F=!1,E=!1;void 0!==r.containerSelector&&(E=n(r.containerSelector));var L=r.urlOriginal||(r.urlPrefix||"")+(r.urlPostfix||"");return L.match(/[a-z]+:/)||(L="http://"+L),P(L,function(t,i){b.find(".original-src").attr("src",i),Y={width:t.naturalWidth,height:t.naturalHeight},(k=new s(r,Y)).on("scaleChanged",function(t){var i={width:t.scaledSize.width+"px",height:t.scaledSize.height+"px"};O.css(i),T.css(i),Z.slider("value",v(t.scale)),w()}),k.on("containerPositionChanged",function(t){var i={left:t.left+"px",top:t.top+"px"};T.css(i),O.css(i),w()}),k.on("cropSizeChanged",function(t){R.css({height:t.height+"px",width:t.width+"px"}),void 0!==t.width&&b.css({width:t.width+"px"}),w()}),k.on("minScaleChanged",function(t){Z.slider({min:v(t.minScale)}),w()}),k.on("modelUpdated",function(t){w(t.reason)}),C()},function(t){setTimeout(H)}),{getScale:function(){return k.getScale()},updateScale:function(t,i,e){return k.updateScale(t,i,e)},getCropHeight:function(){return k.getCropHeight()},updateCropHeight:function(t){return k.updateCropHeight(t)},dispose:H}}(this.element.get(0),this.options,this)},scale:function(t){if(void 0===t)return this.options.instance.getScale();this.options.instance.updateScale(t)},cropHeight:function(t){if(void 0===t)return this.options.instance.getCropHeight();this.options.instance.updateCropHeight(t)},_destroy:function(){this.options.instance.dispose(!0)}})});
//# sourceMappingURL=jqueryui-mosaico-cropper.min.js.map
